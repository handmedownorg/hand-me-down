<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>

<script type="text/javascript">
  function processImage() {

    var subscriptionKey = "eaaddf9ce76e44d3a26929c3dc161266";
    var uriBase =
      "https://westcentralus.api.cognitive.microsoft.com/vision/v2.0/recognizeText";

    // Request parameter.
    var params = {
      "mode": "Handwritten",
    };

    // Display the image.
    var sourceImageUrl = document.getElementById("inputImage").value;
    document.querySelector("#sourceImage").src = sourceImageUrl;
    $.ajax({
      url: uriBase + "?" + $.param(params),

      // Request headers.
      beforeSend: function (jqXHR) {
        jqXHR.setRequestHeader("Content-Type", "application/json");
        jqXHR.setRequestHeader("Ocp-Apim-Subscription-Key", subscriptionKey);
      },

      type: "POST",

      // Request body.
      data: '{"url": ' + '"' + sourceImageUrl + '"}',
    })

      .done(function (data, textStatus, jqXHR) {
        // Show progress.
        $("#responseTextArea").val("Handwritten text submitted. " +
          "Waiting 10 seconds to retrieve the recognized text.");

        setTimeout(function () {

          var operationLocation = jqXHR.getResponseHeader("Operation-Location");


          // Make the second REST API call and get the response.
          $.ajax({
            url: operationLocation,

            // Request headers.
            beforeSend: function (jqXHR) {
              jqXHR.setRequestHeader("Content-Type", "application/json");
              jqXHR.setRequestHeader(
                "Ocp-Apim-Subscription-Key", subscriptionKey);
            },

            type: "GET",
          })

            .done(function (data) {
              // Show formatted JSON on webpage.
              let resJSON = JSON.stringify(data, null, 2);
              //$("#responseTextArea").val(resJSON);
              let resObj = JSON.parse(resJSON);
              
              let resTextArrr = resObj.recognitionResult.lines;
              let resText = resTextArrr.map(e=>e.text).join();
              console.log(resText);

              $("#responseTextArea").val(resText);
            })

            .fail(function (jqXHR, textStatus, errorThrown) {
              // Display error message.
              var errorString = (errorThrown === "") ? "Error. " :
                errorThrown + " (" + jqXHR.status + "): ";
              errorString += (jqXHR.responseText === "") ? "" :
                (jQuery.parseJSON(jqXHR.responseText).message) ?
                  jQuery.parseJSON(jqXHR.responseText).message :
                  jQuery.parseJSON(jqXHR.responseText).error.message;
              alert(errorString);
            });
        }, 5000);
      })

      .fail(function (jqXHR, textStatus, errorThrown) {
        // Put the JSON description into the text area.
        $("#responseTextArea").val(JSON.stringify(jqXHR, null, 2));

        // Display error message.
        var errorString = (errorThrown === "") ? "Error. " :
          errorThrown + " (" + jqXHR.status + "): ";
        errorString += (jqXHR.responseText === "") ? "" :
          (jQuery.parseJSON(jqXHR.responseText).message) ?
            jQuery.parseJSON(jqXHR.responseText).message :
            jQuery.parseJSON(jqXHR.responseText).error.message;
        alert(errorString);
      });
  };
</script>
{{!--
<script src="./AzureOcrAPI/getTextFromPhotoFront.js"></script>
--}}
<div class="form-wrapper">
  <form action="/items/create/{{tag}}" method="POST" id="create-container" enctype="multipart/form-data" class="form">
    <div class="input-div">
      <label for="itemname">Name your item</label>
      <input id="itemname" type="text" name="itemname" placeholder="example: Sara's Book" value="A basket full of grapes">
    </div>
    <div class="input-div">
      <label for="itemowner">Owner</label>
      <input id="itemowner" type="text" name="itemowner" placeholder="Who owns this item?" value="Laura">
    </div>
    <div class="input-div">
      <label for="itemkeeper">Who are you giving the item to?</label>
      <input id="itemkeeper" type="text" name="itemkeeper" placeholder="Who will keep this item?" value="Raul">
    </div>
    <div class="input-div">
      <label>Upload a photo of the tag</label>
      <input type="file" name="tag-photo">
    </div>
    <div class="input-div">
      <label for="password">Item's tag: {{tag}}</label>
      <div id="itemID"></div>
      <p>Write this tag and stick the post-it somewhere in the item.</p>
    </div>
    <br>
    {{#if message }}
    <div class="error-message">{{ message }}</div>
    {{/if}}
    <br><br>
    <button type="submit" value="SAVE">Hand down this item</button>
  </form>
</div>

<div id="image-to-text">
  {{!-- <h1>Read handwritten image:</h1>
  Enter the URL to an image of handwritten text, then click
  the <strong>Read image</strong> button.
  <br><br> --}}
  Image to read:
  <input type="text" name="inputImage" id="inputImage" value="https://res.cloudinary.com/handmedown/image/upload/v1537867904/handmedowntags/tag4.jpg" />
  <button onclick="processImage()">Read image</button>
  <br><br>
  <div id="wrapper" style="width:1020px; display:table;">
    <div id="jsonOutput" style="width:600px; display:table-cell;">
      Response:
      <br><br>
      <textarea id="responseTextArea" class="UIInput" style="width:580px; height:400px;"></textarea>
    </div>
    <div id="imageDiv" style="width:420px; display:table-cell;">
      Source image:
      <br><br>
      <img id="sourceImage" width="400" />
    </div>
  </div>
</div>

<a href="/about">How this works?</a>